---
- name: Documenting Incident #1
  set_fact:
    all_incidents: "{{ all_incidents + [ docs_incident_38 ] }}"
  tags: documentation, incident_38

- name: Create a HPAs associated with Astronomy Shop deployments
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    name: "{{ item }}"
    namespace: "{{ target_namespace_name }}"
    api_version: autoscaling/v2
    kind: HorizontalPodAutoscaler
    state: present
    resource_definition:
      spec:
        scaleTargetRef:
          apiVersion: apps/v1
          kind: Deployment
          name: "{{ item }}"
        minReplicas: 1
        maxReplicas: 10
        metrics:
        - type: Resource
          resource:
            name: cpu
            target:
              type: Utilization
              averageUtilization: 30
    wait: true
  tags: incident_38
  loop: "{{ target_deployments }}"
  when: is_fault_injection | bool

- name: fault_injection_incident_38
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    api_version: apps/v1
    kind: Deployment
    name: "{{ otel_astronomy_app_installation_name }}-loadgenerator"
    namespace: "{{ target_namespace_name }}"
    resource_definition:
      spec:
        replicas: 3
    wait: true
  tags: incident_38
  when: is_fault_injection | bool

- name: Scale down load generator
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    api_version: apps/v1
    kind: Deployment
    name: "{{ otel_astronomy_app_installation_name }}-loadgenerator"
    namespace: "{{ target_namespace_name }}"
    resource_definition:
      spec:
        replicas: 1
    wait: true
  tags: incident_38
  when: is_fault_removal | bool

- name: Remove the HPA associated with Astronomy Shop recommendation service
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    name: "{{ item }}"
    namespace: "{{ target_namespace_name }}"
    api_version: autoscaling/v2
    kind: HorizontalPodAutoscaler
    state: absent
    wait: true
  tags: incident_38
  loop: "{{ target_deployments }}"
  when: is_fault_removal | bool

- name: fault_removal_incident_38
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    api_version: apps/v1
    kind: Deployment
    name: "{{ item }}"
    namespace: "{{ target_namespace_name }}"
    resource_definition:
      spec:
        replicas: 1
    wait: true
  tags: incident_38
  loop: "{{ target_deployments }}"
  when: is_fault_removal | bool
